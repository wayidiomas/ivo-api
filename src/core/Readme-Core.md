# üß† IVO V2 - Core Module

> **N√∫cleo central do sistema** que define modelos, valida√ß√µes, pagina√ß√£o, rate limiting, auditoria e **integra√ß√£o com sistema de autentica√ß√£o** para a arquitetura hier√°rquica Course ‚Üí Book ‚Üí Unit.

## üìÅ Estrutura da Pasta

```
src/core/
‚îú‚îÄ‚îÄ __init__.py                   # Inicializador vazio
‚îú‚îÄ‚îÄ audit_logger.py              # Sistema de auditoria completo + auth tracking
‚îú‚îÄ‚îÄ database.py                  # Inicializador do banco de dados + auth tables
‚îú‚îÄ‚îÄ enums.py                     # Enumera√ß√µes do sistema
‚îú‚îÄ‚îÄ hierarchical_models.py       # Modelos hier√°rquicos Course‚ÜíBook‚ÜíUnit + auth context
‚îú‚îÄ‚îÄ models.py                    # Configura√ß√µes de modelos de IA
‚îú‚îÄ‚îÄ pagination.py                # Sistema de pagina√ß√£o avan√ßado + auth filters
‚îú‚îÄ‚îÄ rate_limiter.py              # Rate limiting com Redis/mem√≥ria + per-token limits
‚îî‚îÄ‚îÄ unit_models.py               # Modelos espec√≠ficos de unidades com IPA
```

## üéØ Responsabilidades Principais

### 1. **Defini√ß√£o da Arquitetura Hier√°rquica**
- Modelos Pydantic para **Course ‚Üí Book ‚Üí Unit**
- Valida√ß√£o autom√°tica de estruturas hier√°rquicas
- Integra√ß√£o com RAG (Retrieval-Augmented Generation)
- Suporte a progress√£o pedag√≥gica sequencial
- **Contexto de autentica√ß√£o** integrado em todos os modelos

### 2. **Valida√ß√£o IPA e Fon√©tica**
- **35+ s√≠mbolos IPA validados** automaticamente
- Valida√ß√£o de transcri√ß√µes fon√©ticas `/fonema/` e `[fonema]`
- Suporte a m√∫ltiplas variantes de pron√∫ncia
- An√°lise de complexidade fon√©tica

### 3. **Sistema de Auditoria Empresarial**
- **22+ tipos de eventos** rastreados incluindo auth events
- Logs estruturados em JSON com contexto de usu√°rio
- M√©tricas de performance autom√°ticas
- Rastreamento de opera√ß√µes hier√°rquicas
- **Security audit trail** completo

### 4. **Rate Limiting Inteligente**
- **Diferentes limites por endpoint** e por token
- Fallback Redis ‚Üí Mem√≥ria
- Identifica√ß√£o por usu√°rio/IP/token
- Headers HTTP autom√°ticos
- **Per-token rate limiting** configur√°vel

### 5. **Pagina√ß√£o Avan√ßada**
- Filtros espec√≠ficos por entidade
- Ordena√ß√£o personalizada
- Metadados completos de navega√ß√£o
- Queries SQL otimizadas
- **Auth-aware filtering** baseado em permiss√µes

### 6. **Integra√ß√£o com Sistema de Autentica√ß√£o** 
- **AuthContext models** para contexto de usu√°rio
- **Token validation** integrada nos core models
- **Permission-based filtering** em pagina√ß√£o
- **Security headers** autom√°ticos
- **Audit logging** de todas as opera√ß√µes autenticadas

---

## üìã Arquivos Detalhados

### üîß `enums.py` - Enumera√ß√µes do Sistema

Define todos os tipos estruturais do IVO V2:

```python
# N√≠veis pedag√≥gicos
class CEFRLevel(str, Enum):
    A1, A2, B1, B2, C1, C2

# Variantes lingu√≠sticas
class LanguageVariant(str, Enum):
    AMERICAN_ENGLISH, BRITISH_ENGLISH, BRAZILIAN_PORTUGUESE...

# Estrat√©gias pedag√≥gicas
class TipStrategy(str, Enum):
    AFIXACAO, COLOCACOES, CHUNKS...  # 6 estrat√©gias

class GrammarStrategy(str, Enum):
    EXPLICACAO_SISTEMATICA, PREVENCAO_ERROS_L1  # 2 estrat√©gias

# Tipos de avalia√ß√£o
class AssessmentType(str, Enum):
    CLOZE_TEST, GAP_FILL, MATCHING...  # 7 tipos

# Status de unidade
class UnitStatus(str, Enum):
    CREATING, VOCAB_PENDING, COMPLETED, ERROR...
```

**Conecta com:**
- Todos os modelos Pydantic
- APIs de valida√ß√£o
- Sistema de progress√£o pedag√≥gica

---

### üèóÔ∏è `hierarchical_models.py` - Arquitetura Course‚ÜíBook‚ÜíUnit

Modelos principais da hierarquia pedag√≥gica:

#### **Course Models**
```python
class CourseCreateRequest(BaseModel):
    name: str
    target_levels: List[CEFRLevel]  # A1‚ÜíB2 progression
    language_variant: LanguageVariant
    methodology: List[str] = ["direct_method", "tips_strategies"]

class Course(BaseModel):
    id: str
    total_books: int
    total_units: int
    created_at: datetime
```

#### **Book Models** 
```python
class BookCreateRequest(BaseModel):
    name: str
    target_level: CEFRLevel  # N√≠vel espec√≠fico do book
    
class Book(BaseModel):
    course_id: str  # Hierarquia obrigat√≥ria
    sequence_order: int
    vocabulary_coverage: List[str]  # RAG tracking
    strategies_used: List[str]      # Balanceamento
```

#### **Unit Models com RAG**
```python
class HierarchicalUnitRequest(BaseModel):
    course_id: str  # OBRIGAT√ìRIO
    book_id: str    # OBRIGAT√ìRIO
    cefr_level: CEFRLevel
    unit_type: UnitType  # lexical_unit | grammar_unit

class UnitWithHierarchy(BaseModel):
    # Hierarquia
    course_id: str
    book_id: str
    sequence_order: int
    
    # Conte√∫do estruturado
    vocabulary: Optional[Dict[str, Any]]
    sentences: Optional[Dict[str, Any]]
    tips: Optional[Dict[str, Any]]
    grammar: Optional[Dict[str, Any]]
    qa: Optional[Dict[str, Any]]
    assessments: Optional[Dict[str, Any]]
    
    # RAG tracking
    strategies_used: List[str]
    vocabulary_taught: List[str]
    status: UnitStatus
    quality_score: Optional[float]
```

#### **RAG Context Models**
```python
class RAGVocabularyContext(BaseModel):
    precedent_vocabulary: List[str]     # Palavras j√° ensinadas
    vocabulary_gaps: List[str]          # Oportunidades novas
    reinforcement_candidates: List[str] # Candidatas a refor√ßo
    progression_level: str              # N√≠vel pedag√≥gico

class RAGStrategyContext(BaseModel):
    used_strategies: List[str]          # Estrat√©gias j√° usadas
    recommended_strategy: str           # Pr√≥xima recomendada
    strategy_rationale: str             # Justificativa

class RAGAssessmentContext(BaseModel):
    used_assessments: List[Dict[str, Any]]
    recommended_assessments: List[AssessmentType]
    balance_rationale: Dict[str, Any]   # An√°lise de balanceamento
```

**Conecta com:**
- `services/hierarchical_database.py` (RAG queries)
- `api/v2/*.py` (endpoints hier√°rquicos)
- Sistema de pagina√ß√£o e filtros

---

### üìö `unit_models.py` - Modelos com Valida√ß√£o IPA

Sistema completo de modelagem de unidades com **valida√ß√£o fon√©tica avan√ßada**:

#### **Vocabulary Models com IPA**
```python
class VocabularyItem(BaseModel):
    word: str                           # Palavra no idioma alvo
    phoneme: str                        # IPA validado: /Ààr…õst…ôr…ënt/
    definition: str                     # Defini√ß√£o em portugu√™s
    example: str                        # Contexto de uso
    word_class: str                     # noun, verb, adjective...
    
    # IPA e Fon√©tica
    ipa_variant: str = "general_american"
    stress_pattern: Optional[str]
    syllable_count: Optional[int]
    alternative_pronunciations: List[str]
    
    # RAG e Progress√£o
    context_relevance: Optional[float]
    is_reinforcement: Optional[bool]
    first_introduced_unit: Optional[str]
    
    @validator('phoneme')
    def validate_ipa_phoneme(cls, v):
        # Valida√ß√£o completa de s√≠mbolos IPA
        valid_ipa_chars = set('a√¶…ô…ë…í…î…™…õ…ú…ùŒ∏√∞ É í ß §≈ã…π…ªÀàÀåÀê...')
        # Verifica delimitadores / / ou [ ]
        # Valida s√≠mbolos individuais
        # Detecta erros comuns
```

#### **Content Models**
```python
class TipsContent(BaseModel):
    strategy: TipStrategy              # AFIXACAO, COLOCACOES...
    explanation: str
    examples: List[str]
    memory_techniques: List[str]
    
    # RAG integration
    vocabulary_coverage: List[str]
    selection_rationale: str
    phonetic_focus: List[str]          # Fonemas focalizados

class GrammarContent(BaseModel):
    strategy: GrammarStrategy          # EXPLICACAO_SISTEMATICA...
    grammar_point: str
    l1_interference_notes: List[str]   # Erros PT‚ÜíEN
    common_mistakes: List[Dict[str, str]]
```

#### **Assessment Models com Balanceamento**
```python
class AssessmentActivity(BaseModel):
    type: AssessmentType               # CLOZE_TEST, GAP_FILL...
    title: str
    content: Dict[str, Any]
    answer_key: Dict[str, Any]
    
    # Balanceamento
    difficulty_level: str
    skills_assessed: List[str]
    pronunciation_focus: bool
    phonetic_elements: List[str]

class AssessmentSection(BaseModel):
    activities: List[AssessmentActivity]  # Sempre 2 atividades
    selection_rationale: str
    balance_analysis: Dict[str, Any]
    underused_activities: List[str]      # RAG balancing
```

#### **Complete Unit Response**
```python
class UnitResponse(BaseModel):
    # Hierarquia obrigat√≥ria
    id: str
    course_id: str
    book_id: str
    sequence_order: int
    
    # Conte√∫do estruturado
    vocabulary: Optional[VocabularySection]
    sentences: Optional[SentencesSection]
    tips: Optional[TipsContent]           # Se lexical_unit
    grammar: Optional[GrammarContent]     # Se grammar_unit
    qa: Optional[QASection]
    assessments: Optional[AssessmentSection]
    
    # Tracking pedag√≥gico
    strategies_used: List[str]
    vocabulary_taught: List[str]
    phonemes_introduced: List[str]        # Novos fonemas
    
    # Qualidade
    quality_score: Optional[float]
    checklist_completed: List[str]        # 22 valida√ß√µes
```

#### **Validation & Analysis Models**
```python
class PhoneticValidationResult(BaseModel):
    word: str
    phoneme: str
    is_valid: bool
    validation_details: Dict[str, Any]
    confidence_score: float

class BulkPhoneticValidation(BaseModel):
    total_items: int
    valid_items: int
    validation_results: List[PhoneticValidationResult]
    common_errors: List[str]
```

**Conecta com:**
- Sistema de valida√ß√£o IPA
- Geradores de conte√∫do (`services/`)
- APIs de cria√ß√£o (`api/v2/`)

---

### üìÑ `pagination.py` - Sistema de Pagina√ß√£o Avan√ßado

Sistema completo de pagina√ß√£o com filtros espec√≠ficos por entidade:

#### **Core Pagination Models**
```python
class PaginationParams(BaseModel):
    page: int = Field(1, ge=1)         # P√°gina (inicia em 1)
    size: int = Field(20, ge=1, le=100) # Itens por p√°gina
    
    @property
    def offset(self) -> int:
        return (self.page - 1) * self.size

class PaginationMeta(BaseModel):
    page: int
    size: int
    total: int
    pages: int
    has_next: bool
    has_prev: bool
    next_page: Optional[int]
    prev_page: Optional[int]

class PaginatedResponse(BaseModel, Generic[T]):
    data: List[T]
    pagination: PaginationMeta
    hierarchy_info: Optional[Dict[str, str]]  # Contexto hier√°rquico
    filters_applied: Optional[Dict[str, Any]]
```

#### **Sorting & Filtering**
```python
class SortParams(BaseModel):
    sort_by: str = "created_at"
    sort_order: str = Field("desc", regex="^(asc|desc)$")

# Filtros espec√≠ficos por entidade
class CourseFilterParams(FilterParams):
    language_variant: Optional[str]
    target_level: Optional[str]
    methodology: Optional[str]

class BookFilterParams(FilterParams):
    target_level: Optional[str]
    course_id: Optional[str]

class UnitFilterParams(FilterParams):
    status: Optional[str]
    unit_type: Optional[str]
    cefr_level: Optional[str]
    book_id: Optional[str]
    course_id: Optional[str]
    quality_score_min: Optional[float]
```

#### **Query Builders**
```python
class QueryBuilder:
    @staticmethod
    def build_courses_query(pagination, sorting, filters) -> str:
        # Gera SQL otimizado para cursos
        
    @staticmethod
    def build_books_query(course_id, pagination, sorting, filters) -> str:
        # Gera SQL para books de um curso espec√≠fico
        
    @staticmethod  
    def build_units_query(book_id, pagination, sorting, filters) -> str:
        # Gera SQL para units de um book espec√≠fico
```

**M√©todos Principais:**
- `create_pagination_params()` - Criar par√¢metros
- `build_sql_query_parts()` - Construir WHERE/ORDER/LIMIT
- `paginate_query_results()` - Criar response paginado

**Conecta com:**
- Todos os endpoints de listagem
- `services/hierarchical_database.py`
- Sistema de filtros por entidade

---

### üõ°Ô∏è `rate_limiter.py` - Rate Limiting Inteligente

Sistema de rate limiting com **diferentes pol√≠ticas por endpoint**:

#### **Core Rate Limiter**
```python
class RateLimiter:
    def __init__(self, redis_url: str):
        # Tenta conectar Redis, fallback para mem√≥ria
        
    async def is_allowed(
        self, 
        request: Request, 
        endpoint: str, 
        limit: int, 
        window: str = "60s"
    ) -> Tuple[bool, Dict[str, any]]:
        # Verifica se request √© permitido
        # Retorna: (is_allowed, rate_info)
```

#### **Configura√ß√µes por Endpoint**
```python
RATE_LIMIT_CONFIG = {
    # Authentication endpoints (public)
    "auth_login": {"limit": 5, "window": "60s"},
    "auth_create_user": {"limit": 3, "window": "60s"},
    "auth_validate_token": {"limit": 20, "window": "60s"},
    
    # Course operations
    "create_course": {"limit": 10, "window": "60s"},
    "list_courses": {"limit": 100, "window": "60s"},
    "get_course": {"limit": 200, "window": "60s"},
    
    # Book operations  
    "create_book": {"limit": 20, "window": "60s"},
    "list_books": {"limit": 150, "window": "60s"},
    
    # Unit operations (mais restritivos)
    "create_unit": {"limit": 5, "window": "60s"},
    "generate_vocabulary": {"limit": 3, "window": "60s"},
    "generate_content": {"limit": 2, "window": "60s"},
    
    # Per-token specific limits (can override defaults)
    "token_specific": {
        # Can be configured per individual token
        # Overrides default endpoint limits
    }
}
```

#### **Dependencies & Middleware**
```python
async def rate_limit_dependency(request: Request, endpoint_name: str):
    # Dependency para FastAPI
    # Levanta HTTPException 429 se limite excedido

class RateLimitMiddleware:
    # Adiciona headers X-RateLimit-* automaticamente
```

**Funcionalidades:**
- **Identifica√ß√£o inteligente**: user_id/token_id > IP > fallback
- **M√∫ltiplas janelas**: 60s, 10m, 1h
- **Fallback robusto**: Redis ‚Üí Mem√≥ria ‚Üí Fail-open
- **Headers autom√°ticos**: X-RateLimit-Limit, Remaining, Reset
- **Per-token rate limiting**: Limites individualizados por token
- **Auth endpoint protection**: Rate limiting espec√≠fico para auth

**Conecta com:**
- Todos os endpoints da API
- Sistema de auditoria (logs de rate limit)
- Middleware global

---

### üìä `audit_logger.py` - Sistema de Auditoria Empresarial

Sistema completo de auditoria com **22 tipos de eventos**:

#### **Event Types**
```python
class AuditEventType(str, Enum):
    # Course operations
    COURSE_CREATED, COURSE_VIEWED, COURSE_UPDATED...
    
    # Book operations
    BOOK_CREATED, BOOK_VIEWED, BOOK_UPDATED...
    
    # Unit operations
    UNIT_CREATED, UNIT_CONTENT_GENERATED...
    
    # Special operations
    RAG_QUERY_EXECUTED, IMAGE_ANALYZED, VOCABULARY_GENERATED...
    
    # Security events
    RATE_LIMIT_EXCEEDED, UNAUTHORIZED_ACCESS...
    
    # Authentication events (NEW)
    AUTH_LOGIN_SUCCESS, AUTH_LOGIN_FAILED, AUTH_TOKEN_CREATED,
    AUTH_TOKEN_VALIDATED, AUTH_TOKEN_EXPIRED, AUTH_USER_CREATED...
    
    # System events
    API_ERROR, PERFORMANCE_ALERT
```

#### **Core Audit Logger**
```python
class AuditLogger:
    async def log_event(
        self,
        event_type: AuditEventType,
        request: Optional[Request],
        resource_info: Optional[Dict[str, Any]],
        performance_metrics: Optional[Dict[str, Any]]
    ):
        # Log estruturado em JSON
        
    async def log_hierarchy_operation(
        self,
        event_type: AuditEventType,
        course_id: Optional[str],
        book_id: Optional[str], 
        unit_id: Optional[str]
    ):
        # Log espec√≠fico para opera√ß√µes hier√°rquicas
        
    async def log_rag_operation(
        self,
        query_type: str,
        results_count: int,
        processing_time: float
    ):
        # Log espec√≠fico para RAG
        
    async def log_content_generation(
        self,
        generation_type: str,
        content_stats: Dict[str, Any],
        ai_usage: Dict[str, Any]
    ):
        # Log para gera√ß√£o de conte√∫do
```

#### **Performance Tracking**
```python
def start_request_tracking(self, request: Request) -> str:
    # Inicia tracking de performance
    
def end_request_tracking(self, request: Request, status_code: int):
    # Finaliza e calcula m√©tricas
    # Auto-log se > 2 segundos
```

#### **Decorators & Context Managers**
```python
@audit_endpoint(
    event_type=AuditEventType.COURSE_CREATED,
    resource_extractor=extract_course_info,
    track_performance=True
)
async def create_course():
    # Auditoria autom√°tica

class AuditContext:
    # Context manager para opera√ß√µes complexas
    async def __aenter__(self):
        # Setup
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        # Log autom√°tico com m√©tricas
```

**Dados Capturados:**
- **Request info**: IP, User-Agent, headers filtrados
- **User info**: user_id, session_id, role, token_id (masked)
- **Resource info**: course_id, book_id, unit_id, hierarchy
- **Performance**: tempo de execu√ß√£o, status codes
- **Content stats**: tokens, AI usage, RAG effectiveness
- **Auth info**: Bearer token usage, scopes, permissions validated

**Conecta com:**
- Todos os endpoints (via decorators)
- Sistema de rate limiting
- M√©tricas de performance
- Logs centralizados (`logs/audit.log`)

---

### üóÑÔ∏è `database.py` - Inicializador do Banco

Inicializa√ß√£o e verifica√ß√£o da estrutura hier√°rquica:

```python
async def init_database():
    # Verificar tabelas hier√°rquicas
    await _check_hierarchical_tables(supabase)
    # Verificar tabelas de autentica√ß√£o
    await _check_auth_tables(supabase)
    # Verificar fun√ß√µes RAG
    await _check_rag_functions(supabase)

async def _check_hierarchical_tables(supabase):
    required_tables = [
        "ivo_courses", 
        "ivo_books", 
        "ivo_units", 
        "ivo_unit_embeddings"
    ]
    # Testa exist√™ncia de cada tabela

async def _check_auth_tables(supabase):
    # Verificar tabelas de autentica√ß√£o
    required_auth_tables = [
        "ivo_users",
        "ivo_api_tokens"
    ]
    # Testa exist√™ncia e configura√ß√£o RLS

async def _check_rag_functions(supabase):
    # Testa fun√ß√£o get_taught_vocabulary
    # Verifica se fun√ß√µes RAG est√£o dispon√≠veis
```

**Conecta com:**
- `config/database.py` (Supabase client)
- Startup da aplica√ß√£o
- Sistema de logs

---

### ‚öôÔ∏è `models.py` - Configura√ß√µes de IA

Configura√ß√£o centralizada dos modelos de IA:

```python
class OpenAISettings(BaseSettings):
    openai_api_key: str
    openai_model: str = "gpt-4-turbo-preview"
    openai_max_tokens: int = 4096
    openai_temperature: float = 0.7

class LangChainSettings(BaseSettings):
    langchain_tracing_v2: bool = True
    langchain_project: str = "curso-na-way"

def load_model_configs() -> Dict[str, Any]:
    # Carrega de models.yaml ou defaults
    return {
        "content_configs": {
            "vocab_generation": {"max_tokens": 2048, "temperature": 0.5},
            "ivo_sentences_generation": {"max_tokens": 1536, "temperature": 0.6},
            "ivo_tips_generation": {"max_tokens": 2048, "temperature": 0.7},
            "ivo_grammar_generation": {"max_tokens": 2048, "temperature": 0.6},
            "ivo_assessments_generation": {"max_tokens": 3072, "temperature": 0.6}
        }
    }
```

**Conecta com:**
- Todos os servi√ßos de gera√ß√£o
- LangChain chains
- Configura√ß√µes por tipo de conte√∫do

---

## üîÑ Fluxo de Integra√ß√£o

### 1. **Startup da Aplica√ß√£o**
```
main.py ‚Üí core/database.py ‚Üí Verifica√ß√£o de estrutura hier√°rquica
                           ‚Üí Verifica√ß√£o de tabelas auth
                           ‚Üí Inicializa√ß√£o de tabelas/fun√ß√µes
                           ‚Üí Setup do middleware de auth
```

### 2. **Request Flow (Com Autentica√ß√£o)**
```
API Request ‚Üí middleware/auth_middleware.py ‚Üí Valida√ß√£o Bearer token
           ‚Üí rate_limiter.py ‚Üí Verifica√ß√£o de limites (per-token)
           ‚Üí audit_logger.py ‚Üí In√≠cio do tracking + user context
           ‚Üí hierarchical_models.py ‚Üí Valida√ß√£o + auth context
           ‚Üí unit_models.py ‚Üí Valida√ß√£o IPA
           ‚Üí audit_logger.py ‚Üí Log final com auth info
```

### 3. **Authentication Flow**
```
Auth Request ‚Üí rate_limiter.py ‚Üí Rate limit auth endpoints
            ‚Üí auth_service.py ‚Üí Valida√ß√£o token IVO
            ‚Üí audit_logger.py ‚Üí Log auth event
            ‚Üí response com Bearer token
```

### 4. **Content Generation Flow (Auth-aware)**
```
Unit Request ‚Üí auth validation ‚Üí Bearer token check
            ‚Üí models.py ‚Üí Configura√ß√£o OpenAI
            ‚Üí hierarchical_models.py ‚Üí Contexto RAG + auth context
            ‚Üí unit_models.py ‚Üí Valida√ß√£o IPA
            ‚Üí audit_logger.py ‚Üí Log de gera√ß√£o + user tracking
```

### 5. **Pagination Flow (Permission-based)**
```
List Request ‚Üí auth validation ‚Üí Permission check
            ‚Üí pagination.py ‚Üí Par√¢metros + Filtros + auth context
            ‚Üí QueryBuilder ‚Üí SQL otimizado + user scope
            ‚Üí PaginatedResponse ‚Üí Metadados completos
```

---

## üéØ Principais Integra√ß√µes Externas

### **Com Services Layer**
- `services/hierarchical_database.py` - RAG queries e contexto
- `services/vocabulary_generator.py` - Valida√ß√£o IPA
- `services/qa_generator.py` - Modelos de assessment

### **Com API Layer**
- `api/v2/*.py` - Todos os endpoints usam modelos core
- Rate limiting e auditoria autom√°tica
- Pagina√ß√£o em listagens

### **Com Infrastructure**
- `config/database.py` - Supabase client
- Redis para rate limiting
- Sistema de logs estruturados

### **Com External Services**
- OpenAI API - Configura√ß√µes centralizadas
- LangChain - Tracking e configura√ß√£o
- MCP (Model Context Protocol) - An√°lise de imagens

---

## üìà M√©tricas de Qualidade

### **Valida√ß√µes Autom√°ticas (22 pontos)**
- ‚úÖ Hierarquia Course‚ÜíBook‚ÜíUnit v√°lida
- ‚úÖ Vocabul√°rio adequado ao n√≠vel CEFR
- ‚úÖ 100% fonemas IPA v√°lidos
- ‚úÖ RAG context applied corretamente
- ‚úÖ Balanceamento de atividades
- ‚úÖ Preven√ß√£o de interfer√™ncia L1‚ÜíL2

### **Performance Targets**
- **IPA Validation**: 97%+ accuracy
- **RAG Deduplication**: 90%+ new vocabulary  
- **Assessment Balance**: 88%+ variety distribution
- **API Response**: <2s automated alerts

### **Audit Coverage**
- **100% endpoint coverage** via decorators
- **Real-time performance tracking**
- **Structured JSON logs** para an√°lise
- **Security event detection** autom√°tico

---

## üöÄ Uso T√≠pico

### **1. Criar Course**
```python
course_request = CourseCreateRequest(
    name="Business English A2-B1",
    target_levels=[CEFRLevel.A2, CEFRLevel.B1],
    language_variant=LanguageVariant.AMERICAN_ENGLISH
)
# Auditoria autom√°tica: COURSE_CREATED
```

### **2. Paginar Books**
```python
pagination = PaginationParams(page=1, size=20)
filters = BookFilterParams(target_level="A2")
# Query builder SQL autom√°tico
```

### **3. Validar IPA**
```python
vocab_item = VocabularyItem(
    word="restaurant",
    phoneme="/Ààr…õst…ôr…ënt/",  # Valida√ß√£o autom√°tica
    definition="estabelecimento comercial"
)
# 35+ s√≠mbolos IPA verificados
```

### **4. Rate Limiting**
```python
@rate_limit_dependency("create_unit")  # 5 req/min
async def create_unit():
    # Autom√°tico: Redis check ‚Üí Headers ‚Üí Exception 429
```

---

## üîß Configura√ß√£o e Setup

### **Environment Variables**
```bash
OPENAI_API_KEY=sk-...
SUPABASE_URL=https://...
SUPABASE_KEY=...
REDIS_URL=redis://localhost:6379  # Opcional
LANGCHAIN_API_KEY=...             # Opcional

# Authentication (NOVO)
TEST_API_KEY_IVO=ivo_test_token_dev_only_remove_in_prod  # Dev token
JWT_SECRET_KEY=...                # Para assinatura de tokens (opcional)
```

### **Dependencies**
```bash
pip install pydantic fastapi redis supabase langchain openai
```

### **Initialization**
```python
from src.core.database import init_database
from src.core.audit_logger import audit_logger_instance
from src.core.rate_limiter import rate_limiter
from src.services.auth_service import AuthService

await init_database()  # Verificar estrutura hier√°rquica + auth
# Rate limiter e audit logger s√£o singletons globais
# AuthService integrado automaticamente via middleware
```

---

## üéì Resumo Executivo

O m√≥dulo **`src/core/`** √© o **n√∫cleo inteligente** do IVO V2, fornecendo:

1. **üèóÔ∏è Arquitetura Hier√°rquica** - Course‚ÜíBook‚ÜíUnit com RAG
2. **üî§ Valida√ß√£o IPA Avan√ßada** - 35+ s√≠mbolos fon√©ticos validados
3. **üìä Auditoria Empresarial** - 22+ tipos de eventos estruturados incluindo auth
4. **üõ°Ô∏è Rate Limiting Inteligente** - Diferentes pol√≠ticas por endpoint + per-token
5. **üìÑ Pagina√ß√£o Avan√ßada** - Filtros espec√≠ficos por entidade + auth-aware
6. **‚öôÔ∏è Configura√ß√£o Centralizada** - OpenAI, LangChain, banco de dados
7. **üîê Sistema de Autentica√ß√£o Integrado** - Bearer tokens + audit trail + RLS

**Resultado**: Base s√≥lida que garante **qualidade pedag√≥gica**, **performance otimizada**, **seguran√ßa empresarial** e **monitoramento completo** para todo o sistema IVO V2.